@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model ESTA.ViewModels.GetUserForums
@using Microsoft.AspNetCore.Identity;
@inject UserManager<User> userManager;
@inject SignInManager<User> signInManager;
@{
    var IsSigned = signInManager.IsSignedIn(User);
    var role = false;

    if (IsSigned)
    {
        var user = await userManager.GetUserAsync(User);
        role = await userManager.IsInRoleAsync(user, "Admin") || await userManager.IsInRoleAsync(user, "Moderator");
    }

    var admin = role.ToString().ToLower();
    ICollection<ESTA.ViewModels.GetUserForums> commentList = new List<ESTA.ViewModels.GetUserForums>();
    commentList.Add(Model);
}
<style>
    .delete {
        color: red !important;
    }
</style>
<div class="container">
    <div class="card x-75">
        <div class="card-body">
            @await Html.PartialAsync("_RenderComment", new ESTA.ViewModels.RenderComment
            {
            showAllLink = false,
            showReply = true,
            UserForums = commentList
            })
            <input type="hidden" value="@Model.Id" id="ParentId" />
            <input type="hidden" value="@Model.forumId" id="ForumId" />
            <input type="hidden" value="@Url.Action("DeleteComment")" id="AjaxDelCmnt" />
            <input type="hidden" value="@Url.Action("DeleteReply")" id="AjaxDelRpl" />
            <input type="hidden" value="@Url.Action("BanUser","Forums")" id="AjaxBanUser" />
        </div>
    </div>
</div>

<div class="modal" tabindex="-1" id="exampleModalToggle">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are You sure you want to Ban This User!</p>
                <div class='row'>
                    <div class='col-12'>
                        <textarea maxlength="450" rows="3" class='form-control' id="BanReason" type='text' placeholder='Enter reason' aria-label='Enter reason ...'></textarea>
                    </div>
                    <div id="reasonErr" class="text-danger">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button onclick="BanUserConfirm()" class="btn btn-danger">Ban</button>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script src="~/js/forumsfuncs.js"></script>
    <script>
        var pageNo = 0
        var userId = 0
        var forumId = 0

        $(document).ready(function () {
            getReplies();
        });
        function AddReply(id) {
            if ($('#reply' + id).val()) {
                $.ajax({
                    type: 'post',
                    dataType: 'JSON',
                    url: '@this.Url.Action("AddReply","Forums")',
                    data: {
                        forumId: $('#ForumId').val(),
                        comment: $('#reply' + id).val(),
                        parentId: id
                    },
                    success: function (data) {
                        $('#reply' + id).val('')
                        pageNo = 1
                        ListReplies(data, false)
                        $('#replyToggle' + id).css('visibility', 'visible')

                        checkCommentReplies()
                    },
                    error: function (data) {
                        console.log('hiii')
                    }
                });
            }
            else {
                $('#rplyErr').text('Enter valid reply')
            }
        }
        function getReplies() {
            var id = $('#ParentId').val()
            $.ajax({
                type: 'get',
                dataType: 'JSON',
                url: '@this.Url.Action("GetCommentReplies","Forums")',
                data: {
                    parentId: $('#ParentId').val(),
                    page: pageNo++
                },
                success: function (data) {
                    checkCommentReplies()
                    $('#reply' + id).val('')
                    ListReplies(data, true)
                },
                error: function (data) {
                    console.log(data)
                }
            });
        }
        function ListReplies(data, append) {
            var str = ""
            var id = $('#ParentId').val()
            $.each(data, function (i, obj) {

                str += "<li id='comment" + obj.id + "' class='mb-3'><div class='comments-box d-flex'><div class='comments-avatar'><img src='https://i.imgur.com/CFpa3nK.jpg' alt='' class='rounded-circle shadow-1-strong me-3' width='65' height='65'></div>" +
                    "<div class='comments-text'><div class='avatar-name'><h5>" + obj.userName + "<span class='small'> - " + formatDate(obj.createdDate) + "</span></h5></div><p>" + obj.comment + "</p>";
                if (@admin) {
                    str += "<a onclick='DeleteReply" + obj.id + "' class='link-danger delete'>Delete</a>";
                    if(obj.banned){
                        str += "<a href='#' class='link-secondary mx-2'>Banned</a>";
                    }
                    else{
                        str += "<a onclick='BanUser(\"" + obj.userId + "\",\"" + obj.forumId + "\")' class='link-danger mx-2'>Ban User</a>";
                    }
                }
                str += "</div></div></li>";
            });
            if (append) {
                $('#replyList' + id).append(str);
            }
            else
                $('#replyList' + id).html(str);
            $('#replyCollapse' + id).collapse('show');
        }

        function checkCommentReplies() {
            $.ajax({
                type: 'get',
                dataType: 'JSON',
                url: '@this.Url.Action("CheckCommentReplies","Forums")',
                data: {
                    parentId: $('#ParentId').val(),
                    page: pageNo
                },
                success: function (data) {
                    if (!data) {
                        $('#MoreBtn').hide();
                    }
                },
                error: function (data) {
                    console.log(data)
                }
            });
        }

    </script>
}